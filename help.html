<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Help ‚Äî Gnoke Gas</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:#f7f6f2; --surface:#ffffff; --surface2:#f0ede8; --border:#e2ddd8;
      --text:#1c1917; --muted:#a8a29e; --flame:#ea580c;
      --flame-dim:rgba(234,88,12,0.09); --success:#16a34a;
      --success-glow:rgba(22,163,74,0.1);
      --danger:#dc2626; --danger-dim:rgba(220,38,38,0.09);
      --radius:6px; --nav-h:60px;
      --font-mono:'DM Mono',monospace; --font-sans:'DM Sans',sans-serif;
    }
    html { font-size:15px; }
    body { font-family:var(--font-sans); background:var(--bg); color:var(--text);
      min-height:100dvh; padding-bottom:calc(var(--nav-h) + 12px);
      -webkit-font-smoothing:antialiased; }

    .page-header { position:sticky; top:0; z-index:20; background:var(--flame);
      padding:12px 16px; display:flex; align-items:center; justify-content:space-between; }
    .page-header h1 { font-family:var(--font-mono); font-size:0.82rem; font-weight:500;
      letter-spacing:0.14em; text-transform:uppercase; color:#fff; }

    .card { margin:12px; background:var(--surface); border:1px solid var(--border);
      border-radius:var(--radius); overflow:hidden; }
    .card-header { padding:11px 16px; border-bottom:1px solid var(--border); }
    .card-header h2 { font-family:var(--font-mono); font-size:0.68rem; font-weight:500;
      letter-spacing:0.1em; text-transform:uppercase; color:var(--muted); }
    .card-body { padding:16px; }

    /* Business profile form */
    .field { display:flex; flex-direction:column; gap:5px; margin-bottom:12px; }
    .field:last-child { margin-bottom:0; }
    .field label { font-family:var(--font-mono); font-size:0.62rem; letter-spacing:0.08em;
      text-transform:uppercase; color:var(--muted); }
    .field input, .field textarea {
      background:var(--surface2); border:1px solid var(--border);
      border-radius:var(--radius); color:var(--text); font-family:var(--font-sans);
      font-size:0.85rem; padding:9px 11px; outline:none; transition:border-color 0.15s;
      width:100%; resize:none; }
    .field input:focus, .field textarea:focus { border-color:var(--flame); }
    .field input::placeholder, .field textarea::placeholder { color:var(--muted); }

    /* Data snapshot */
    .data-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:1px;
      background:var(--border); border-radius:4px; overflow:hidden; margin-bottom:16px; }
    .data-cell { background:var(--surface2); padding:12px; text-align:center; }
    .data-val { font-family:var(--font-mono); font-size:1.05rem; font-weight:500;
      color:var(--flame); display:block; }
    .data-label { font-family:var(--font-mono); font-size:0.58rem; letter-spacing:0.08em;
      text-transform:uppercase; color:var(--muted); margin-top:3px; display:block; }

    /* Action pair */
    .action-pair { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .action-btn { display:flex; flex-direction:column; align-items:center;
      justify-content:center; gap:6px; padding:16px 10px; border-radius:var(--radius);
      cursor:pointer; border:none; font-family:var(--font-sans);
      transition:opacity 0.15s,transform 0.1s; }
    .action-btn:active { transform:scale(0.97); }
    .action-btn .ab-icon { font-size:1.5rem; line-height:1; }
    .action-btn .ab-label { font-size:0.82rem; font-weight:600; }
    .action-btn .ab-sub { font-family:var(--font-mono); font-size:0.6rem; opacity:0.7; }
    .btn-backup { background:var(--flame-dim); border:1px solid rgba(234,88,12,0.22);
      color:var(--flame); }
    .btn-restore { background:var(--success-glow); border:1px solid rgba(22,163,74,0.22);
      color:var(--success); }
    .btn-backup:hover, .btn-restore:hover { opacity:0.82; }

    /* Reset */
    .reset-btn { width:100%; display:flex; align-items:center; justify-content:center;
      gap:8px; padding:12px; background:var(--danger-dim);
      border:1px solid rgba(220,38,38,0.2); border-radius:var(--radius);
      color:var(--danger); font-family:var(--font-sans); font-size:0.82rem;
      font-weight:600; cursor:pointer; transition:opacity 0.15s,transform 0.1s; }
    .reset-btn:active { transform:scale(0.97); }
    .reset-btn:hover  { opacity:0.85; }

    /* Save button */
    .save-btn { width:100%; padding:12px; background:var(--flame); color:#fff;
      border:none; border-radius:var(--radius); font-family:var(--font-sans);
      font-size:0.88rem; font-weight:600; cursor:pointer;
      transition:opacity 0.15s,transform 0.1s; margin-top:4px; }
    .save-btn:active { transform:scale(0.97); }
    .save-btn:hover  { opacity:0.88; }

    /* Quick ref */
    .qr-row { display:flex; align-items:flex-start; gap:12px;
      padding:10px 0; border-bottom:1px solid var(--border); }
    .qr-row:last-child { border-bottom:none; }
    .qr-icon { font-size:1rem; line-height:1.4; flex-shrink:0; width:22px; text-align:center; }
    .qr-title { font-size:0.84rem; font-weight:600; margin-bottom:2px; }
    .qr-desc  { font-size:0.78rem; color:var(--muted); line-height:1.5; }

    /* Contact */
    .contact-links { display:flex; flex-direction:column; gap:8px; }
    .contact-link { display:flex; align-items:center; gap:10px; padding:10px 12px;
      background:var(--surface2); border:1px solid var(--border);
      border-radius:var(--radius); text-decoration:none; color:var(--text);
      font-size:0.84rem; transition:border-color 0.15s; }
    .contact-link:hover { border-color:var(--flame); }
    .contact-link .cl-icon { font-size:1rem; flex-shrink:0; }
    .contact-link .cl-val { font-family:var(--font-mono); font-size:0.75rem; color:var(--flame); }
    .contact-link .cl-sub { font-size:0.7rem; color:var(--muted); margin-bottom:1px; }

    .version-line { text-align:center; padding:16px;
      font-family:var(--font-mono); font-size:0.62rem;
      color:var(--muted); letter-spacing:0.08em; }

    #toast { position:fixed; bottom:calc(var(--nav-h) + 12px); left:50%;
      transform:translateX(-50%) translateY(20px); background:var(--surface);
      border:1px solid var(--border); border-radius:var(--radius);
      padding:9px 18px; font-size:0.8rem; color:var(--text);
      box-shadow:0 4px 20px rgba(0,0,0,0.08); opacity:0;
      transition:opacity 0.2s,transform 0.2s;
      pointer-events:none; white-space:nowrap; z-index:100; }
    #toast.show    { opacity:1; transform:translateX(-50%) translateY(0); }
    #toast.success { border-color:var(--success); color:var(--success); }
    #toast.error   { border-color:var(--danger);  color:var(--danger); }

    .bottom-nav { position:fixed; bottom:0; left:0; right:0; height:var(--nav-h);
      background:var(--surface); border-top:1px solid var(--border);
      display:flex; align-items:stretch; z-index:20; }
    .bottom-nav a { flex:1; display:flex; flex-direction:column; align-items:center;
      justify-content:center; text-decoration:none; gap:3px;
      font-family:var(--font-mono); font-size:0.6rem; letter-spacing:0.08em;
      text-transform:uppercase; color:var(--muted); transition:color 0.15s; position:relative; }
    .bottom-nav a .nav-icon { font-size:1.1rem; line-height:1; }
    .bottom-nav a:hover  { color:var(--text); }
    .bottom-nav a.active { color:var(--flame); }
    .bottom-nav a.active::before { content:''; position:absolute; top:0;
      left:20%; right:20%; height:2px; background:var(--flame);
      border-radius:0 0 3px 3px; }


    /* Migration banner */
    .migrate-card { margin:12px; background:#fffbeb; border:1px solid #fcd34d;
      border-radius:var(--radius); overflow:hidden; }
    .migrate-card .card-header { background:#fffbeb; border-bottom:1px solid #fcd34d; padding:11px 16px; }
    .migrate-card .card-header h2 { color:#92400e; }
    .migrate-card .card-body { padding:16px; }
    .migrate-desc { font-size:0.82rem; color:#78350f; line-height:1.6; margin-bottom:14px; }
    .migrate-btn { width:100%; padding:13px; background:#d97706; color:#fff;
      border:none; border-radius:var(--radius); font-family:var(--font-sans);
      font-size:0.88rem; font-weight:600; cursor:pointer;
      transition:opacity 0.15s,transform 0.1s; }
    .migrate-btn:active { transform:scale(0.97); }
    .migrate-btn:hover  { opacity:0.88; }
    .migrate-btn:disabled { opacity:0.5; cursor:not-allowed; }
    .migrate-log { margin-top:12px; background:#fff7ed; border:1px solid #fcd34d;
      border-radius:4px; padding:10px 12px; max-height:160px; overflow-y:auto; }
    .migrate-log p { font-family:var(--font-mono); font-size:0.65rem;
      color:#92400e; letter-spacing:0.04em; line-height:1.8; }

    #db-loader { position:fixed; inset:0; background:var(--bg); display:flex;
      flex-direction:column; align-items:center; justify-content:center;
      gap:14px; z-index:200; transition:opacity 0.3s; }
    #db-loader.hidden { opacity:0; pointer-events:none; }
    .loader-ring { width:34px; height:34px; border:2px solid var(--border);
      border-top-color:var(--flame); border-radius:50%;
      animation:spin 0.7s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    #db-loader p { font-family:var(--font-mono); font-size:0.7rem;
      color:var(--muted); letter-spacing:0.1em; }
  </style>
</head>
<body>

<div id="db-loader"><div class="loader-ring"></div><p>LOADING...</p></div>

<header class="page-header">
  <h1>Help</h1>
</header>

<!-- Business profile -->
<div class="card">
  <div class="card-header"><h2>Business Profile</h2></div>
  <div class="card-body">
    <div class="field">
      <label for="bizName">Business Name</label>
      <input type="text" id="bizName" placeholder="e.g. Sparrow Gas Depot" />
    </div>
    <div class="field">
      <label for="bizPhone">Phone</label>
      <input type="tel" id="bizPhone" placeholder="e.g. 08012345678" inputmode="tel" />
    </div>
    <div class="field">
      <label for="bizAddress">Address</label>
      <textarea id="bizAddress" rows="2" placeholder="e.g. 14 Market Road, Port Harcourt"></textarea>
    </div>
    <button class="save-btn" onclick="saveCompany()">Save Profile</button>
  </div>
</div>

<!-- Data & backup -->
<div class="card">
  <div class="card-header"><h2>Your Data</h2></div>
  <div class="card-body">
    <div class="data-grid">
      <div class="data-cell">
        <span class="data-val" id="snapDays">‚Äî</span>
        <span class="data-label">Days</span>
      </div>
      <div class="data-cell">
        <span class="data-val" id="snapSales">‚Äî</span>
        <span class="data-label">Sales</span>
      </div>
      <div class="data-cell">
        <span class="data-val" id="snapRev">‚Äî</span>
        <span class="data-label">Revenue</span>
      </div>
    </div>
    <div class="action-pair">
      <button class="action-btn btn-backup" onclick="backup()">
        <span class="ab-icon">‚§ì</span>
        <span class="ab-label">Backup</span>
        <span class="ab-sub">.db file</span>
      </button>
      <button class="action-btn btn-restore" onclick="triggerRestore()">
        <span class="ab-icon">‚§í</span>
        <span class="ab-label">Restore</span>
        <span class="ab-sub">from file</span>
      </button>
    </div>
    <input type="file" id="restoreInput" accept=".db" style="display:none"
           onchange="restore(event)" />
  </div>
</div>

<!-- Migration banner ‚Äî hidden after migration runs -->
<div class="migrate-card" id="migrateCard" style="display:none">
  <div class="card-header"><h2>‚ö° Import Old Data</h2></div>
  <div class="card-body">
    <p class="migrate-desc">
      We found data from the previous version of this app.
      Tap below to import your sales history into the new database.
      This runs once and cannot be undone.
    </p>
    <button class="migrate-btn" id="migrateBtn" onclick="runMigration()">
      Import Previous Records
    </button>
    <div class="migrate-log" id="migrateLog" style="display:none"></div>
  </div>
</div>

<!-- Quick ref -->
<div class="card">
  <div class="card-header"><h2>Quick Reference</h2></div>
  <div class="card-body" style="padding:0 16px">
    <div class="qr-row">
      <span class="qr-icon">‚öñÔ∏è</span>
      <div>
        <div class="qr-title">Set unit price first</div>
        <div class="qr-desc">Enter the price per KG at the top of the Sales page before recording entries. Changing it recalculates all existing rows for the day.</div>
      </div>
    </div>
    <div class="qr-row">
      <span class="qr-icon">üì•</span>
      <div>
        <div class="qr-title">Stock carries forward</div>
        <div class="qr-desc">Opening stock for each new day is automatically set to yesterday's closing balance. You can adjust it manually if needed.</div>
      </div>
    </div>
    <div class="qr-row">
      <span class="qr-icon">‚ó∑</span>
      <div>
        <div class="qr-title">History is live</div>
        <div class="qr-desc">Every sale you record appears in History immediately. Today's record is always at the top.</div>
      </div>
    </div>
    <div class="qr-row">
      <span class="qr-icon">üíæ</span>
      <div>
        <div class="qr-title">Backup regularly</div>
        <div class="qr-desc">Your data lives in this browser only. Export a .db backup and store it on your phone or cloud storage.</div>
      </div>
    </div>
  </div>
</div>

<!-- Danger zone -->
<div class="card">
  <div class="card-header"><h2>Danger Zone</h2></div>
  <div class="card-body">
    <button class="reset-btn" onclick="resetAll()">‚ö† Reset All Data</button>
  </div>
</div>

<!-- Contact -->
<div class="card">
  <div class="card-header"><h2>Support</h2></div>
  <div class="card-body">
    <div class="contact-links">
      <a class="contact-link" href="mailto:edmundsparrow@gmail.com">
        <span class="cl-icon">‚úâ</span>
        <div>
          <div class="cl-sub">Email</div>
          <div class="cl-val">edmundsparrow@gmail.com</div>
        </div>
      </a>
      <a class="contact-link" href="https://wa.me/09024054758" target="_blank">
        <span class="cl-icon">üí¨</span>
        <div>
          <div class="cl-sub">WhatsApp</div>
          <div class="cl-val">09024054758</div>
        </div>
      </a>
    </div>
  </div>
</div>

<div class="version-line">GNOKE GAS ¬∑ v1.0 ¬∑ DATA STAYS ON YOUR DEVICE</div>

<div id="toast"></div>

<nav class="bottom-nav">
  <a href="sales.html"><span class="nav-icon">üõí</span>Sales</a>
  <a href="history.html"><span class="nav-icon">‚ó∑</span>History</a>
  <a href="help.html" class="active"><span class="nav-icon">‚öô</span>Help</a>
</nav>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
<script src="scripts/db-core.js"></script>
<script src="scripts/db-sales.js"></script>
<script src="scripts/migrate.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
<script>
let _tt;
function toast(msg, type='') {
  const el = document.getElementById('toast');
  el.textContent = msg; el.className = `show ${type}`;
  clearTimeout(_tt); _tt = setTimeout(() => el.className='', 2600);
}

function renderSnapshot() {
  const days  = DB.query('SELECT COUNT(*) AS n FROM days')[0]?.n  ?? 0;
  const sales = DB.query('SELECT COUNT(*) AS n FROM sales WHERE kg > 0')[0]?.n ?? 0;
  const rev   = DB.query('SELECT COALESCE(SUM(price),0) AS t FROM sales')[0]?.t ?? 0;
  document.getElementById('snapDays').textContent  = days;
  document.getElementById('snapSales').textContent = sales;
  // Short format for small space
  const revNum = Number(rev);
  document.getElementById('snapRev').textContent   =
    revNum >= 1000000 ? `‚Ç¶${(revNum/1000000).toFixed(1)}M`
    : revNum >= 1000  ? `‚Ç¶${(revNum/1000).toFixed(1)}K`
    : DB.formatNaira(revNum);
}

function loadProfile() {
  const c = DBSales.getCompany();
  if (!c) return;
  document.getElementById('bizName').value    = c.name    || '';
  document.getElementById('bizPhone').value   = c.phone   || '';
  document.getElementById('bizAddress').value = c.address || '';
}

async function saveCompany() {
  const name    = document.getElementById('bizName').value.trim();
  const phone   = document.getElementById('bizPhone').value.trim();
  const address = document.getElementById('bizAddress').value.trim();
  try {
    await DBSales.saveCompany({ name, phone, address });
    toast('Profile saved', 'success');
  } catch(e) {
    toast('Save failed', 'error');
  }
}

function backup() {
  try {
    const date = new Date().toISOString().slice(0,10);
    DB.exportDB(`gnoke-gas-backup-${date}.db`);
    toast('Backup downloaded', 'success');
  } catch(e) {
    toast('Backup failed', 'error');
  }
}

function triggerRestore() {
  document.getElementById('restoreInput').click();
}

async function restore(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (!file.name.endsWith('.db')) { toast('Select a .db file', 'error'); return; }
  if (!confirm('Restore will replace all current data. Continue?')) {
    e.target.value=''; return;
  }
  try {
    await DB.restoreDB(file);
    toast('Restored ‚Äî reloading‚Ä¶', 'success');
    setTimeout(() => window.location.reload(), 1200);
  } catch(err) {
    toast('Restore failed', 'error');
  }
  e.target.value='';
}

async function resetAll() {
  if (!confirm('Delete ALL sales history and data? This cannot be undone.')) return;
  if (!confirm('Final confirmation ‚Äî are you sure?')) return;
  try {
    await DB.run('DELETE FROM sales');
    await DB.run('DELETE FROM days');
    localStorage.removeItem('gnoke_gas_skip_intro');
    toast('All data cleared', 'success');
    renderSnapshot();
  } catch(e) {
    toast('Reset failed', 'error');
  }
}


async function runMigration() {
  const btn = document.getElementById('migrateBtn');
  const log = document.getElementById('migrateLog');

  if (!confirm('Import all records from the previous app? Your existing data will not be overwritten.')) return;

  btn.disabled = true;
  btn.textContent = 'Importing‚Ä¶';
  log.style.display = '';
  log.innerHTML = '';

  function addLog(msg) {
    const p = document.createElement('p');
    p.textContent = '‚Ä∫ ' + msg;
    log.appendChild(p);
    log.scrollTop = log.scrollHeight;
  }

  try {
    const result = await Migrate.run(addLog);

    if (result.migrated === 0 && !result.skipped) {
      addLog('No old records found.');
    } else {
      addLog(`Complete ‚Äî ${result.migrated} days, ${result.sales} entries imported.`);
    }

    btn.textContent = '‚úì Import Complete';
    // Hide the card after a short delay
    setTimeout(() => {
      document.getElementById('migrateCard').style.display = 'none';
    }, 3000);

    renderSnapshot();
    toast('Migration complete', 'success');

  } catch(e) {
    addLog('Error: ' + e.message);
    btn.disabled = false;
    btn.textContent = 'Retry Import';
    toast('Migration failed', 'error');
  }
}

function checkMigration() {
  // Show the migration card only if migration hasn't run
  // AND the old LocalForage library is available
  if (typeof localforage !== 'undefined' && !Migrate.isDone()) {
    // Peek into old store to see if there's anything there
    const oldStore = localforage.createInstance({ name:'salesApp', storeName:'salesData' });
    oldStore.keys().then(keys => {
      if (keys && keys.length) {
        document.getElementById('migrateCard').style.display = '';
      }
    }).catch(() => {});
  }
}

async function init() {
  try {
    await DB.init({
      locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/${f}`
    });
    loadProfile();
    renderSnapshot();
    checkMigration();
  } catch(e) {
    document.getElementById('db-loader').querySelector('p').textContent =
      'ERROR: ' + e.message;
    return;
  }
  const loader = document.getElementById('db-loader');
  loader.classList.add('hidden');
  setTimeout(() => loader.remove(), 350);
}

init();
</script>
</body>
</html>
